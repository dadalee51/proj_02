<!DOCTYPE html>
<meta http-equiv="Content-Security-Policy"
  content="default-src *; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline' 'unsafe-eval' http://www.google.com">
<html>
<script note="helper functions">clog = (a) => console.log(a);</script>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Accounts Payable</title>
  <script src="alpine.js"></script>
  <link href="bootstrap.min.css" rel="stylesheet">
</head>
<body>
  <div x-data="{
    invoice_number: '',
    vendor: '',
    amount: '',
    invoices: []
  }">
    <!--this is a test of alpine's x-init and x-text functions to load some api results to screen.-->
    <!--div x-init="invoices = await(await fetch('/api/invoices')).json()" x-text="JSON.stringify(invoices)">some data here?</div-->
    <!--div x-init="invoices = await(await fetch('/api/invoices')).json()"></div-->
    <div x-init="$watch(Alpine.store('invoices',invoices))">
      <form x-on:submit.prevent="addInvoice">
        <label for="invoice_number">Invoice Number:</label>
        <input type="text" x-model="invoice_number" id="invoice_number">
        <label for="vendor">Vendor:</label>
        <input type="text" x-model="vendor" id="vendor">
        <label for="amount">Amount:</label>
        <input type="text" x-model="amount" id="amount">
        <button type="submit">Add Invoice</button>
      </form>
      <table>
        <thead>
          <tr>
            <th>Invoice Number</th>
            <th>Vendor</th>
            <th>Amount
            <th>
          </tr>
        </thead>
        <tbody>
          <template x-for="(invoice, index) in Alpine.store('invoices')" :key="index">
            <tr>
              <td x-text="invoice.invoice_number"></td>
              <td x-text="invoice.vendor"></td>
              <td x-text="invoice.amount"></td>
            </tr>
          </template>
        </tbody>
      </table>
    </div>
  </div>
  <script>
    Alpine.store('invoices', []);
    getInvoices();

    async function addInvoice() {
      const invoice_number = document.querySelector('#invoice_number').value
      const vendor = document.querySelector('#vendor').value
      const amount = document.querySelector('#amount').value

      const data = {
        invoice_number,
        vendor,
        amount
      }
      const response = await fetch('/api/invoices', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
      })

      if (!response.ok) {
        console.error(response.statusText)
        return
      }

      document.querySelector('#invoice_number').value = ''
      document.querySelector('#vendor').value = ''
      document.querySelector('#amount').value = ''

      getInvoices()
    }

    async function getInvoices() {
      const response = await fetch('/api/invoices', {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json'
        }
      })

      if (!response.ok) {
        console.error(response.statusText)
        return
      }
      const data = await response.json()
      Alpine.store('invoices', data);
    }
  </script>
</body>
</html>