<!DOCTYPE html>
<meta http-equiv="Content-Security-Policy"
  content="default-src *; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline' 'unsafe-eval' http://www.google.com">
<html>
<script note="helper functions">clog = (a) => console.log(a);</script>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Student credit system</title>
  <script src="alpine.js"></script>
  <link href="bootstrap.min.css" rel="stylesheet">
</head>
<body>
  <div x-data="{
    student_number: '',
    timestamp: '',
    total_credits: '',
    student_name: '',
    credits: []
  }">
    <div x-init="$watch(Alpine.store('credits',credits))">
      <form x-on:submit.prevent="addCredit">
        <label for="student_number">student Number:</label>
        <input type="text" x-model="student_number" id="student_number">
        <label for="timestamp">Timestamp:</label>
        <input type="text" x-model="timestamp" id="timestamp">
        <label for="total_credits">total_credits:</label>
        <input type="text" x-model="total_credits" id="total_credits">
        <label for="student_name">student_name:</label>
        <input type="text" x-model="student_name" id="student_name">
        <button type="submit">Add student</button>
      </form>
      <table>
        <thead>
          <tr>
            <th>student Number</th>
            <th>Timestamp</th>
            <th>total_credits</th>
            <th>student_name</th>
          </tr>
        </thead>
        <tbody>
          <template x-for="(credit, index) in Alpine.store('credits')" :key="index">
            <tr>
              <td x-text="credit.student_number"></td>
              <td x-text="credit.timestamp"></td>
              <td x-text="credit.total_credits"></td>
              <td x-text="credit.student_name"></td>
              <td><button x-on:click="deleteStudent(credit)">Delete</button></td>
            </tr>
          </template>
        </tbody>
      </table>
    </div>
  </div>
  <script>
    Alpine.store('credits', []);
    getcredits();

    async function addCredit() {
      const student_number = document.querySelector('#student_number').value
      const timestamp = document.querySelector('#timestamp').value
      const total_credits = document.querySelector('#total_credits').value
      const student_name = document.querySelector('#student_name').value

      const data = {
        student_number,
        timestamp,
        total_credits,
        student_name
      }
      const response = await fetch('/api/credit', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      })

      if (!response.ok) {
        console.error(response.statusText)
        return
      }

      document.querySelector('#student_number').value = ''
      document.querySelector('#timestamp').value = ''
      document.querySelector('#total_credits').value = ''
      document.querySelector('#student_name').value = ''

      getcredits()
    }

    async function getcredits() {
      const response = await fetch('/api/credit', {
        method: 'GET',
        headers: {'Content-Type': 'application/json'}
      })

      if (!response.ok) {
        console.error(response.statusText)
        return
      }
      const data = await response.json()
      Alpine.store('credits', data);
    }

    function deleteStudent(credit) {
        if (confirm(`Are you sure you want to delete ${credit.student_name}?`)) {
          fetch(`/api/credit/${credit.student_number}`, {
            method : 'DELETE'
        })
        .then(() => {
          getcredits();
        })
          .catch(error => console.error(error));
        }
    }

  </script>
</body>
</html>